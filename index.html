<!DOCTYPE html>
<html>

<head>
    <title>Solar Tracker Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        .box {
            padding: 15px;
            margin-bottom: 20px;
            background: #f0f0f0;
            border-radius: 12px;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <h2>Solar Tracker IoT Dashboard</h2>

    <!-- Control Buttons -->
    <div class="box">
        <button onclick="sendCmd('on')">System ON</button>
        <button onclick="sendCmd('off')">System OFF</button>
        <button onclick="sendCmd('home')">Home Position</button>
    </div>

    <!-- Speed -->
    <div class="box">
        <label>Tracking Speed</label>
        <input type="range" min="0" max="5" value="1" oninput="sendSpeed(this.value)">
    </div>

    <!-- PID -->
    <div class="box">
        <label>Kp</label><input id="kp" type="number" step="0.01">
        <label>Ki</label><input id="ki" type="number" step="0.01">
        <label>Kd</label><input id="kd" type="number" step="0.01">
        <button onclick="sendPID()">Update PID</button>
    </div>

    <!-- Threshold -->
    <div class="box">
        <label>LDR Threshold</label>
        <input type="number" id="thr" oninput="sendThreshold(this.value)">
    </div>

    <!-- Graph -->
    <div class="box">
        <h3>Error Graph</h3>
        <canvas id="errorChart"></canvas>
    </div>

    <script>
        //////////////////////////////////////////////////////////////
        // MQTT CONNECTION
        //////////////////////////////////////////////////////////////

        const client = mqtt.connect("wss://105ec4fd38e24b628e90f82d2a916a24.s1.eu.hivemq.cloud:8884/mqtt", {
            username: "hivemq.webclient.1762934161918",
            password: "58jb.1<,6FIwmqHdCD>R"
        });

        client.on("connect", () => {
            console.log("MQTT connected!");
            client.subscribe("solar/status");
        });

        client.on("message", (topic, msg) => {
            console.log("Status:", msg.toString());

            let val = parseFloat(msg.toString());
            addErrorData(val);
        });

        //////////////////////////////////////////////////////////////
        // COMMAND SEND FUNCTIONS
        //////////////////////////////////////////////////////////////

        function sendCmd(command) {
            client.publish("solar/control", JSON.stringify({ cmd: command }));
        }

        function sendSpeed(v) {
            client.publish("solar/control",
                JSON.stringify({ cmd: "speed", value: Number(v) }));
        }

        function sendThreshold(v) {
            client.publish("solar/control",
                JSON.stringify({ cmd: "threshold", value: Number(v) }));
        }

        function sendPID() {
            const kp = Number(document.getElementById("kp").value);
            const ki = Number(document.getElementById("ki").value);
            const kd = Number(document.getElementById("kd").value);

            client.publish("solar/control",
                JSON.stringify({ cmd: "pid", kp, ki, kd }));
        }

        //////////////////////////////////////////////////////////////
        // REAL-TIME CHART
        //////////////////////////////////////////////////////////////

        const ctx = document.getElementById("errorChart");
        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "Tracking Error",
                    data: [],
                    borderWidth: 2
                }]
            },
            options: {
                animation: false
            }
        });

        function addErrorData(value) {
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push("");
            chart.data.datasets[0].data.push(value);
            chart.update();
        }
    </script>

</body>

</html>
